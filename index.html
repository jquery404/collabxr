<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LR Map</title>
    <link rel="icon" href="favicon.ico" sizes="16x16" type="image/x-icon">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <style>
        body{background-color: #F8F8FB;}
        span.round {border-radius: 50%;color: #fff;text-align: center;background: #000;padding: 5px 8px;}
        .cat_label {
            display: flex;
            flex-flow: row wrap;
            justify-content: space-around;
            padding: 0;
            margin: 1em 0;
            list-style: none;
            background: #ffd893;
        }
        .cat_label li{ font-size: 10px; font-weight: 700;}
        #parsed_csv_list { font-size: 0.75rem; }
    </style>
</head>

<body>
<div class="container-fluid">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-2">
        <a class="navbar-brand" href="#">XR Collaboration</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
          </ul>
        </div>
    </nav>

    <div class="row justify-content-center">
        <div class="col-11">
            <div id="sankey_basic" class="mb-3" style="height: 600px; margin:0 auto;"></div>
            <div>
                <ul class="cat_label">
                    <li>Input Type</li> 
                    <li>Device Type</li> 
                    <li>Interaction (Cue)</li> 
                    <li>Cue Type</li> 
                    <li>Evaluation Type</li>
                </ul>
            </div>
            <div id="bar_basic" class="mb-3" style="height: 600px; margin:0 auto;"></div>
            <div id="year_bar_basic" class="mb-3" style="height: 600px; margin:0 auto;"></div>
        </div>
        <div class="col-11 mt-5 pt-5">
            <div id="parsed_csv_list"></div>
        </div>
    </div>

    <footer class="page-footer font-small blue">
        <div class="footer-copyright text-center py-3">&copy; 2020 Copyright:
          <a href="https://jquery404.github.io/"> Faisal Zaman</a>
        </div>
      </footer>
</div>


<script>
    var sankeyChart, barChart, yearBarChart, searchStr;
    var InputCat = ['Panorama image', 'Panorama video', 'Point clouds', '360 video', 'Mobile video', 'Mobile Image', '3D Scene'];
    var DeviceCat = ['HMD', 'HHD', 'SAR', 'PC'];
    var InteractCat = ['Visual', 'Haptic', 'Auditory'];
    var UICat = ['Pointer', 'Viewframe', 'FoV',	'Glove', 'Gaze', 'Avatar', 'Gesture', 'Voice'];
    var UXCat = ['Decision making', 'Usability', 'Presence', 'Perception', 'Emotion'];

    
    document.addEventListener("DOMContentLoaded", function(event) { 
        loadCSV();
    });

    function loadChart(){
        google.load('visualization', '1.1', {packages: ['sankey', 'corechart', 'bar']});
        google.setOnLoadCallback(drawSankeyChart);
        google.setOnLoadCallback(drawBarChart);
        google.setOnLoadCallback(drawYearBarChart);
    }

    function drawYearBarChart() {
        var finalYr = countYearTable();
        var dataTbl = [['', 'Number of Papers', { role: 'style' }]];
        for (var i=0; i<finalYr.length; i++)
            dataTbl.push(finalYr[i]);

        var data = google.visualization.arrayToDataTable(dataTbl);

        var options = {
            title: 'Distribution of the papers by year of publication',
            chartArea: {width: '60%'},
            vAxis: { title: 'Number of Papers', minValue: 0 },
            hAxis: {title: ''},
            legend: {position: 'none'}
        };

        yearBarChart = new google.visualization.ColumnChart(document.getElementById('year_bar_basic'));
        yearBarChart.draw(data, options);
    }

    function drawBarChart() {
        var finalPub = countPublisherTable();
        var dataTbl = [['', 'Number of Papers']];
        for (var i=0; i<finalPub.length; i++)
            dataTbl.push(finalPub[i]);

        var data = google.visualization.arrayToDataTable(dataTbl);

        var options = {
            title: 'Publication Venue Breakdown',
            chartArea: {width: '80%'},
            vAxis: { title: 'Number of Papers', minValue: 0 },
            hAxis: {title: ''}
        };

        barChart = new google.visualization.ColumnChart(document.getElementById('bar_basic'));
        barChart.draw(data, options);
    }

    function drawSankeyChart() {
        var data = new google.visualization.DataTable();
        var formatter = new google.visualization.NumberFormat({pattern:'$###.## bn'}); 
        var colors = ['#a6cee3', '#b2df8a', '#fb9a99', '#fdbf6f',
                    '#cab2d6', '#ffff99', '#1f78b4', '#33a02c'];
        data.addColumn('string', 'From');
        data.addColumn('string', 'To');
        data.addColumn('number', 'Weight');
        //data.addColumn({type: 'string', role: 'tooltip', 'p': {'html': true}});
        
        
        // data.addRows([
        // [ 'Panorama image', 'HHD', 9 ],
        // [ 'Panorama image', 'HMD', 10 ],
        // [ 'Panorama image', 'SAR', 11 ],
        // [ 'Panorama image', 'PC', 7 ],
        // ].map(function(d){
        //     //d.push(formatter.formatValue(d[2])+ ' This is an HTML tooltip<br>It needs to be formatted nicely<br>in a rectangular box that is not <i>long and thin</i>');
        //     return d;
        // }));
            
        // Sets chart options.
        var options = {
            tooltip: {
                isHtml: true,
                textStyle: {fontName: 'Times-Roman', color: '#000', fontSize:12 }, 
                showColorCode: true,
            },
            sankey: {
                link: {
                    colorMode: 'gradient',
                    colors: colors
                },
                node: {
                    pattern: '$### m',
                    interactivity: true
                }
            },
            animation: {
                duration: 1000,
                easing: 'out'
            },
        };

        sankeyChart = new google.visualization.Sankey(document.getElementById('sankey_basic'));
        google.visualization.events.addListener(sankeyChart, 'select', selectHandler);
        
        sankeyChart.draw(data, options);
        var count = 1;
        var asd = setInterval(function(){
            if(count == 1)
                data.addRows(uglyArray(InputCat, DeviceCat, 2, 3));
            else if(count == 2)
                data.addRows(uglyArray(DeviceCat, InteractCat, 3, 7));
            else if(count == 3)
                data.addRows(uglyArray(InteractCat, UICat, 7, 8));
            else if(count == 4)
                data.addRows(uglyArray(UICat, UXCat, 8, 11));
            else
                clearInterval(asd);
            
            sankeyChart.draw(data, options);
            count++;
        }, 1000);
    }

    function selectHandler(e) {
        var selection = sankeyChart.getSelection();
        var id;

        for (var key in selection){
            var value = selection[key];

            var found = InputCat.find(function(elem){ return elem === value.name; });
            if(found) id = 2;
            else {
                found = DeviceCat.find(function(elem){ return elem === value.name;});
                if(found) id = 3;
                else {
                    found = InteractCat.find(function(elem){ return elem === value.name;});
                    if(found) id = 7;
                    else{
                        found = UICat.find(function(elem){ return elem === value.name;});
                        if(found) id = 8;
                        else{
                            found = UXCat.find(function(elem){ return elem === value.name;});
                            if(found) id = 11;
                        }
                    }
                }
            }
            
            filterTable(value, id);
        }
    }

    function loadCSV(){
        var config = buildConfig();
        Papa.parse('lr.csv', config);
    }

    function parseHTMLTable(results){
        var table = "<table class='table' id='myTable'>";
        var data = results.data;
        var colors = ['#a6cee3', '#b2df8a', '#fb9a99', '#fdbf6f',
                    '#cab2d6', '#ffff99', '#1f78b4', '#33a02c'];
            
        for(i=0;i<data.length;i++){
            table+= "<tr>";
            var row = data[i];
            var cells = row.join(",").split(",");
                
            for(j=0;j<cells.length;j++){
                if(i==0){
                    if (j==0) table+= "<th>No</th>";
                    table+= "<th>"+cells[j]+"</th>";
                    if (j==cells.length-1) table+="<th>Contrib</th>";
                }else{
                    // if (j==cells.length-1){
                    //     table+= "<td>";
                    //     table+= (cells[j] == 1) ? "<img class='img-thumbnail' src='gfx/"+cells[0].toLowerCase()+".jpg'/>" : ""; 
                    //     table+= "</td>";
                    // }else{
                        if (j==0) table+= "<td>"+i+"</td>";
                        table+= "<td>";
                        table+= cells[j];
                        table+= "</td>";
                        if (j==cells.length-1) table+="<td><span class='round' style='background: "+colors[Math.floor(Math.random()*colors.length)]+"';>"+makeid(1)+"</span></td>";

                    // }
                }
                
            }
            table+= "</tr>";
        }
        table+= "</table>";
        document.getElementById("parsed_csv_list").innerHTML = table;

        loadChart();
    }

    function buildConfig() {
        return {
            download: true,
            delimiter: "auto",
            complete: parseHTMLTable
        };
    }

    // filter
    function uglyArray(arr1, arr2, pos1, pos2){
        var arr = [];
        for(var i=0; i< arr1.length; i++){
            for(var j=0; j<arr2.length; j++){
                if(pos2==11) console.log([arr1[i], arr2[j], countTable(arr1[i], arr2[j], pos1, pos2)]);
                arr.push([arr1[i], arr2[j], countTable(arr1[i], arr2[j], pos1, pos2)]);
            }
        }
        console.log(arr);
        return arr;
    }

    function countTable(str1, str2, pos1, pos2){
        var count = 0;
        var table = document.getElementById("myTable");
        var tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[pos1];
            tdd = tr[i].getElementsByTagName("td")[pos2];
            if (td && tdd) {
                txtValue = td.textContent.toUpperCase().indexOf(str1.toUpperCase());
                txtValue1 = tdd.textContent.toUpperCase().indexOf(str2.toUpperCase());
                if(pos2==11) count=1;
                else if (txtValue > -1 && txtValue1 > -1) {
                    ++count;
                }
            }  
        }
        
        return count == 0 ? 1 : count;
    }

    function filterTable(str, id){
        var count = 0;
        var table = document.getElementById("myTable");
        var tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
            if(id==7){
                td = tr[i].getElementsByTagName("td")[id];
                tdd = tr[i].getElementsByTagName("td")[id+1];
                if (td) {
                    txtValue = td.textContent.toUpperCase().indexOf(str.name.toUpperCase());
                    txtValue1 = tdd.textContent.toUpperCase().indexOf(str.name.toUpperCase());

                    if (txtValue > -1 || txtValue1 > -1) {
                        ++count;
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }else{
                td = tr[i].getElementsByTagName("td")[id];
                if (td) {
                    txtValue = td.textContent.toUpperCase().indexOf(str.name.toUpperCase());

                    if (txtValue > -1) {
                        ++count;
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
        
        return count;
    }

    function checkArray(item){
        return item === searchStr;
    }

    function countPublisherTable(){
        var pub = [], finalpub = [];
        var table = document.getElementById("myTable");
        var tr = table.getElementsByTagName("tr");

        //publisher = 14
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[14];
            if (td) {
                txtValue = td.textContent.toUpperCase();
                if(txtValue != '')
                    pub.push(txtValue.trim());
            }  
        }
        var pubClean = removeDuplicates(pub);
        
        for (j = 0; j < pubClean.length; j++) {
            var count = 0;
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[14];
                if (td) {
                    txtValue = td.textContent.toUpperCase().indexOf(pubClean[j].toUpperCase());
                    if (txtValue > -1) ++count;
                }  
            }
            finalpub.push([pubClean[j], count]);
        }
        return finalpub;
    }

    function countYearTable(){
        var pub = [], finalpub = [];
        var table = document.getElementById("myTable");
        var tr = table.getElementsByTagName("tr");

        //year = 15
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td")[15];
            if (td) {
                txtValue = td.textContent.toUpperCase();
                if(txtValue != '')
                    pub.push(txtValue.trim());
            }  
        }
        var pubClean = removeDuplicates(pub);
        
        for (j = 0; j < pubClean.length; j++) {
            var count = 0;
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[15];
                if (td) {
                    txtValue = td.textContent.toUpperCase().indexOf(pubClean[j].toUpperCase());
                    if (txtValue > -1) ++count;
                }  
            }
            var color = '#';
            var range = 'ABCDEF';
            for (var i = 0; i < 6; i++ ) {
                color += range.charAt(Math.floor(Math.random() * range.length));
            }


            finalpub.push([pubClean[j], count, color]);
        }
        return finalpub.sort();
    }

    function removeDuplicates(array) {
        return array.filter((a, b) => array.indexOf(a) === b)
    };

    function makeid(length) {
        var result           = '';
        var characters       = 'CFTDNRK';
        var charactersLength = characters.length;
        for ( var i = 0; i < length; i++ ) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }

</script>
</body>
</html>